<script>
  const EMOJI = {
    happy: "üôÇ Happy",
    sad: "üò¢ Sad",
    angry: "üò† Angry",
    neutral: "üòê Neutral"
  };

  // === 0) Config ===
  const MODEL_URL = "https://teachablemachine.withgoogle.com/models/4nP7aQpCm/";
  const TOP_K = 3;
  const LOW_CONF = 0.6;
  const CAM_INFER_MS = 300;

  // === 1) DOM helpers & refs ===
  const el = (id)=>document.getElementById(id);
  const $status = el('status');
  const $msg = el('msg');
  const $video = el('video');
  const $img = el('img');
  const $canvas = el('canvas');
  const $pred = el('predictions');
  const $bars = el('bars');
  const $guide = el('guidance');
  const $err = el('errorBox');
  const $ok = el('okBox');
  const $progress = el('progress');
  const $progressBox = el('progressBox');

  const $btnCam = el('btnCam');
  const $file = el('file');
  const $btnReset = el('btnReset');
  const $btnNextWeather = el('btnNextWeather');
  const $weatherSection = el('weather-section');
  const $finalSection = el('final-section');
  const $predSection = el('pred-section');
  const $btnRestart = el('btnRestart');
  const $btnCapture = el('btnCapture');
  const $countdown = el('countdown');
  const $weatherResult = el('weatherResult');

  // === State ===
  const MOOD_TO_STYLE = { happy:"Active", neutral:"Minimal", sad:"Cozy", angry:"Street" };
  let step = 1;
  let selectedEmotion = null;
  let selectedStyle = null;
  let selectedWeather = null;

  let model, maxPredictions;
  let webcamStream = null;
  let inferTimer = null;
  let lastInfer = 0;
  let isCountingDown = false;

  // Accessibility helpers
  function announce(html, cls=""){
    $msg.className = cls || "";
    $msg.innerHTML = html;
    $msg.classList.remove('hidden');
  }
  function setError(e){
    $err.textContent = e;
    $err.classList.remove('hidden');
    $ok.classList.add('hidden');
  }
  function setOk(t="System is running normally."){
    $ok.textContent = t;
    $ok.classList.remove('hidden');
    $err.classList.add('hidden');
  }

  // === 3) Load model ===
  async function loadModel(){
    try{
      if (typeof tmImage === 'undefined') {
        throw new Error('Teachable Machine library (tmImage) is not loaded. Please check your network or CDN blocking.');
      }
      if (!window.isSecureContext && !location.hostname.match(/^localhost|127\.0\.0\.1$/)) {
        console.warn('Insecure context: camera access requires HTTPS or localhost.');
      }
      if(!MODEL_URL || !MODEL_URL.startsWith('http')){
        throw new Error('Please set a valid MODEL_URL.');
      }

      $status.textContent = 'Loading model‚Ä¶';
      $progressBox.classList.remove('hidden');

      let p=0;
      const t = setInterval(()=>{
        p = Math.min(p+8, 96);
        $progress.value = p;
      }, 120);

      const modelURL = MODEL_URL + 'model.json';
      const metadataURL = MODEL_URL + 'metadata.json';
      try{
        const [headModel, headMeta] = await Promise.all([
          fetch(modelURL, { method:'GET' }),
          fetch(metadataURL, { method:'GET' })
        ]);
        if(!headModel.ok) throw new Error('model.json responded with '+headModel.status+'. Please check the URL or public access settings.');
        if(!headMeta.ok) throw new Error('metadata.json responded with '+headMeta.status+'. Please check the URL or public access settings.');
      }catch(pre){
        clearInterval(t);
        $progress.value=0;
        $progressBox.classList.add('hidden');
        throw pre;
      }

      model = await tmImage.load(modelURL, metadataURL);
      clearInterval(t);
      $progress.value = 100;
      setTimeout(()=>{$progressBox.classList.add('hidden');}, 300);

      maxPredictions = model.getTotalClasses();
      setOk('Model loaded ('+maxPredictions+' classes).');
      $btnCam.disabled = false;
      $status.textContent = 'Ready. Choose an input to start.';
    }catch(e){
      console.error(e);
      setError('Failed to load model: '+ e.message);
      $status.textContent = 'Stopped due to an error.';
    }
  }

  // === 4) File upload (Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÌõÑ ÏòàÏ∏°) ===
  $file.addEventListener('change', (ev)=>{
    try{
      const f = ev.target.files && ev.target.files[0];
      if(!f){
        announce('No file selected.','muted');
        return;
      }
      if(!f.type.startsWith('image/')){
        setError('This is not a valid image file.');
        return;
      }

      stopCamera();
      $video.classList.add('hidden');
      $img.classList.remove('hidden');

      const url = URL.createObjectURL(f);

      $img.onload = async ()=>{
        URL.revokeObjectURL(url);
        try{
          await predictOnce($img);
        }catch(e){
          setError('Error predicting image: ' + e.message);
        }
      };

      $img.src = url;
    }catch(e){
      setError('Error while processing file: '+ e.message);
    }
  });

  // === 5) Camera ===
  async function startCamera(){
    try{
      stopCamera();
      $status.textContent = 'Requesting camera permission‚Ä¶';
      webcamStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      $video.srcObject = webcamStream;
      $video.muted = true;
      $video.setAttribute('playsinline','');
      await $video.play();

      $img.classList.add('hidden');
      $video.classList.remove('hidden');
      $btnCapture.disabled = false;

      $status.textContent = 'Camera input active‚Ä¶';
      $btnCam.textContent = 'Stop Camera';
      $btnCam.setAttribute('aria-pressed','true');
    }catch(e){
      console.error(e);
      setError('Unable to start camera (permission denied or device not supported).');
    }
  }

  function stopCamera(){
    if(inferTimer){clearInterval(inferTimer); inferTimer=null}
    if(webcamStream){
      webcamStream.getTracks().forEach(t=>t.stop());
      webcamStream = null;
    }
    isCountingDown = false;
    $countdown.classList.add('hidden');
    $btnCapture.disabled = true;
    $btnCam.textContent = 'Start Camera';
    $btnCam.setAttribute('aria-pressed','false');
  }

  function startCountdownAndCapture(){
    if(!webcamStream){
      announce('Please turn on the camera first.','muted');
      return;
    }
    if(isCountingDown) return;

    isCountingDown = true;
    let count = 3;

    $countdown.textContent = count;
    $countdown.classList.remove('hidden');
    $status.textContent = 'Taking a photo in 3 seconds‚Ä¶';

    const timer = setInterval(async () => {
      count--;
      if(count > 0){
        $countdown.textContent = count;
      }else{
        clearInterval(timer);
        $countdown.classList.add('hidden');
        isCountingDown = false;
        $status.textContent = 'Capturing frame‚Ä¶';

        try{
          await predictOnce($video);
          $status.textContent = 'Prediction complete.';
        }catch(e){
          console.error(e);
          setError('Error while predicting from camera: ' + e.message);
        }
      }
    }, 1000);
  }

  function startPredictLoop(){
    if(!model || !$video || !webcamStream) return;
    const loop = (ts) => {
      if(!webcamStream) return;
      if (ts - lastInfer >= CAM_INFER_MS) {
        lastInfer = ts;
        predictOnce($video).catch(console.warn);
      }
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  $btnCam.addEventListener('click',()=>{
    if(webcamStream) stopCamera(); else startCamera();
  });

  $btnCapture.addEventListener('click', startCountdownAndCapture);

  // Manual emotion selection
  ['pickHappy','pickNeutral','pickSad','pickAngry'].forEach(id=>{
    const elBtn = document.getElementById(id);
    if(!elBtn) return;
    elBtn.addEventListener('click',()=>{
      const m = elBtn.getAttribute('data-emote');
      if(m){ setEmotionAndEnableNext(m); }
    });
  });

  // Next: weather selection
  $btnNextWeather.addEventListener('click',()=>{
    gotoWeatherStep();
  });

  // Weather buttons (ÏàòÎèô ÏÑ†ÌÉùÎèÑ Ïú†ÏßÄ)
  $weatherSection.querySelectorAll('button[data-weather]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      selectedWeather = btn.getAttribute('data-weather');
      showFinalCard();
    });
  });

  // Restart
  $btnRestart.addEventListener('click',()=>{
    selectedEmotion = null;
    selectedStyle = null;
    selectedWeather = null;
    step = 1;
    $predSection.classList.remove('hidden');
    $weatherSection.classList.add('hidden');
    $finalSection.classList.add('hidden');
    $pred.textContent = 'Waiting for results‚Ä¶';
    $guide.textContent = '';
    $btnNextWeather.disabled = true;
    stopCamera();
    $video.classList.add('hidden');
    $img.classList.add('hidden');
    setOk('Restarting from the beginning.');
  });

  // Reset
  $btnReset.addEventListener('click',()=>{
    stopCamera();
    $video.classList.add('hidden');
    $img.src = '';
    $img.classList.add('hidden');
    $pred.textContent = 'Waiting for results‚Ä¶';
    $guide.textContent = '';
    setOk();
    announce('Reset complete.','muted');
  });

  // === 6) Inference ===
  async function predictOnce(sourceEl){
    if(!model){
      announce('Please load the model first.','muted');
      return;
    }
    const W=224, H=224;
    $canvas.width=W; $canvas.height=H;
    const ctx=$canvas.getContext('2d');
    ctx.drawImage(sourceEl,0,0,W,H);

    const predictions = await model.predict($canvas);
    const sorted = predictions.sort((a,b)=>b.probability - a.probability).slice(0, TOP_K);

    const lines = sorted.map(p=>{
      const pct = (p.probability*100).toFixed(1);
      return `${p.className.padEnd(12,' ')}  ${pct}%`;
    });
    $pred.textContent = lines.join('\n');

    renderBars(sorted);

    const best = sorted[0];
    if(best && best.probability < LOW_CONF){
      $guide.innerHTML =
        'Low confidence. Try <strong>simplifying the background</strong>, ' +
        '<strong>improving lighting</strong>, and ' +
        '<strong>filling the frame with your face</strong>, then run it again.';
    }else{
      $guide.textContent = '';
    }

    if (best) {
      const label = (best.className || '').toLowerCase();
      let emote = null;
      if(label.includes('happy')) emote = 'happy';
      else if(label.includes('neutral')) emote = 'neutral';
      else if(label.includes('sad')) emote = 'sad';
      else if(label.includes('angry')) emote = 'angry';

      if(emote){
        setEmotionAndEnableNext(emote);
      }
    }

    setOk();
  }

  function setEmotionAndEnableNext(emote){
    selectedEmotion = emote;
    selectedStyle = MOOD_TO_STYLE[emote] || null;
    $btnNextWeather.disabled = !selectedStyle;
    if(selectedStyle){
      announce(
        `Emotion: <strong>${emote}</strong> ‚Üí Style: <strong>${selectedStyle}</strong>`,
        'muted'
      );
    }
  }

  // === 7) Weather API (Open-Meteo) ===
  async function fetchWeatherByLatLon(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error('Weather API error: ' + res.status);
    }
    const data = await res.json();
    if (!data.current || typeof data.current.weather_code !== 'number') {
      throw new Error('Invalid weather API response');
    }
    return data.current.weather_code;
  }

  function mapCodeToWeatherText(code) {
    if ([0, 1].includes(code)) return "Sunny";          // ÎßëÏùå
    if ([2, 3, 45, 48].includes(code)) return "Cloudy"; // Íµ¨Î¶Ñ/ÏïàÍ∞ú
    return "Rainy";                                     // ÎÇòÎ®∏ÏßÄ ‚Üí ÎπÑ/Îàà
  }

  async function autoSetWeather() {
    if (!$weatherResult) return;

    $weatherResult.textContent = "Detecting your current weather...";

    if (!navigator.geolocation) {
      $weatherResult.textContent = "Geolocation not supported. Please pick manually.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        try {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const code = await fetchWeatherByLatLon(lat, lon);
          const w = mapCodeToWeatherText(code);

          selectedWeather = w;
          $weatherResult.innerHTML =
            `Detected weather: <strong>${w}</strong> (you can change it below)`;

          announce(
            `Detected weather: <strong>${w}</strong>. You can keep this or pick another one.`,
            "muted"
          );
        } catch (e) {
          console.error(e);
          $weatherResult.textContent = "Weather detection failed. Please pick manually.";
        }
      },
      (err) => {
        console.error(err);
        $weatherResult.textContent = "Weather detection blocked. Please pick manually.";
      }
    );
  }

  // === 8) Weather step Ï†ÑÌôò ===
  function gotoWeatherStep(){
    if(!selectedStyle){
      announce('Please select an emotion or finish face detection first.','muted');
      return;
    }
    step = 2;
    $predSection.classList.add('hidden');
    $weatherSection.classList.remove('hidden');
    $finalSection.classList.add('hidden');

    if ($weatherResult) {
      $weatherResult.textContent = "Detecting your current weather...";
    }
    autoSetWeather();
  }

  // === 9) Final card ===
  function showFinalCard(){
    if (!selectedStyle || !selectedWeather) {
      announce('Style or weather information is missing. Please select again.','muted');
      return;
    }

    const target = RECOMMENDATIONS.find(card =>
      card.mood === selectedStyle && card.weather === selectedWeather
    );
    const list = target ? [target] : [];

    renderCards(list);

    step = 3;
    $predSection.classList.add('hidden');
    $weatherSection.classList.add('hidden');
    $finalSection.classList.remove('hidden');

    $finalSection.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // === 10) Network status ===
  function updateOnline(){
    if(navigator.onLine){ setOk('Online ‚Äî model can run.'); }
    else{ setError('Offline ‚Äî the first model load requires an internet connection.'); }
  }
  window.addEventListener('online', updateOnline);
  window.addEventListener('offline', updateOnline);

  // === 11) Init ===
  (async ()=>{
    updateOnline();
    await loadModel();
  })();

  // ====== 12) Card data ======
  const RECOMMENDATIONS = [
    { id:"active_sunny",  title:"Active √ó Sunny",  mood:"Active",  weather:"Sunny",
      hero:"assets_img/active_sunny.jpg",
      palette_text:"Red / Orange / Yellow (high energy)",
      items:["Cotton T-shirt","Mini skirt","Sneakers"],
      accessories:["Sunglasses","Cap","Beaded bracelet"],
      description:"Bright, free energy that matches a sunny day." },

    { id:"active_cloudy", title:"Active √ó Cloudy", mood:"Active", weather:"Cloudy",
      hero:"assets_img/active_cloudy.jpg",
      palette_text:"Red / Orange / Yellow (slightly toned down)",
      items:["T-shirt + light cardigan","Lightweight pants"],
      accessories:["Bucket hat","Small crossbody bag"],
      description:"Stay active on cloudy days with light layers." },

    { id:"active_rainy",  title:"Active √ó Rainy",  mood:"Active",  weather:"Rainy",
      hero:"assets_img/active_rainy.jpg",
      palette_text:"Red / Orange / Yellow with a neutral outer layer",
      items:["Light rain jacket","Long pants","Water-resistant sneakers"],
      accessories:["Umbrella or bucket hat","Practical backpack"],
      description:"Add a bright inner layer under a rain-proof outer for energy." },

    { id:"minimal_sunny", title:"Minimal √ó Sunny", mood:"Minimal", weather:"Sunny",
      hero:"assets_img/minimal_sunny.jpg",
      palette_text:"Beige / Light Blue / White (clean)",
      items:["Light blue shirt","White pants"],
      accessories:["Mini leather tote","Simple metal watch"],
      description:"Clean, well-organized look with bright tone-on-tone colors." },

    { id:"minimal_cloudy", title:"Minimal √ó Cloudy", mood:"Minimal", weather:"Cloudy",
      hero:"assets_img/minimal_cloudy.jpg",
      palette_text:"Beige / Light Blue / White (balanced)",
      items:["Shirt + cardigan","Chino pants"],
      accessories:["Slim belt","Minimal sneakers"],
      description:"Soft mid-tones to keep a calm and balanced mood on cloudy days." },

    { id:"minimal_rainy", title:"Minimal √ó Rainy", mood:"Minimal", weather:"Rainy",
      hero:"assets_img/minimal_rainy.jpg",
      palette_text:"Beige / Light Blue / White (rain-friendly)",
      items:["Beige trench coat","Shirt","Slacks"],
      accessories:["Mini tote bag","Metal watch"],
      description:"Keep your silhouette clean and simple even on rainy days." },

    { id:"cozy_sunny",   title:"Cozy √ó Sunny",   mood:"Cozy",   weather:"Sunny",
      hero:"assets_img/cozy_sunny.jpg",
      palette_text:"Navy / Black / Gray (lightweight cozy)",
      items:["Light knit top","Relaxed-fit pants"],
      accessories:["Soft light scarf","Canvas bag"],
      description:"Soft knit and gentle tones for a relaxed, cozy mood." },

    { id:"cozy_cloudy",  title:"Cozy √ó Cloudy",  mood:"Cozy",   weather:"Cloudy",
      hero:"assets_img/cozy_cloudy.jpg",
      palette_text:"Navy / Black / Gray (warm)",
      items:["Knit sweater","Coat"],
      accessories:["Scarf","Warm-textured bag"],
      description:"Low-saturation tones and warm textures for comfort and stability." },

    { id:"cozy_rainy",   title:"Cozy √ó Rainy",   mood:"Cozy",   weather:"Rainy",
      hero:"assets_img/cozy_rainy.jpg",
      palette_text:"Navy / Black / Gray (weather-ready)",
      items:["Hooded coat","Dark jeans"],
      accessories:["Water-resistant boots (Chelsea)","Umbrella"],
      description:"Combine warmth and water protection to stay cozy in the rain." },

    { id:"street_sunny", title:"Street √ó Sunny", mood:"Street", weather:"Sunny",
      hero:"assets_img/street_sunny.jpg",
      palette_text:"Purple / Brown / Green (light mix)",
      items:["Graphic T-shirt","Cargo shorts"],
      accessories:["Cap","Chain bracelet"],
      description:"Lightweight pieces with street-style color points for sunny days." },

    { id:"street_cloudy", title:"Street √ó Cloudy", mood:"Street", weather:"Cloudy",
      hero:"assets_img/street_cloudy.jpg",
      palette_text:"Purple / Brown / Green (muted)",
      items:["Oversized hoodie","Wide-leg pants"],
      accessories:["Chunky sneakers","Crossbody bag"],
      description:"Stand out in gray weather with bold silhouettes and details." },

    { id:"street_rainy", title:"Street √ó Rainy", mood:"Street", weather:"Rainy",
      hero:"assets_img/street_rainy.jpg",
      palette_text:"Purple / Brown / Green (tech mix)",
      items:["Rain jacket","Cargo pants"],
      accessories:["Water-repellent bucket hat","High-grip sneakers"],
      description:"Techwear-inspired pieces that balance strong style and practicality." }
  ];

  // Render bar chart
  function renderBars(list){
    if(!$bars || !Array.isArray(list)) return;
    $bars.innerHTML = '';

    const top1 = list[0];

    list.forEach(p=>{
      const pct = Math.round(p.probability * 100);
      const rawLabel = p.className.toLowerCase();

      let key = "neutral";
      if(rawLabel.includes("happy")) key = "happy";
      else if(rawLabel.includes("sad")) key = "sad";
      else if(rawLabel.includes("angry")) key = "angry";

      const displayLabel = (p === top1)
        ? `üî• ${EMOJI[key]}`
        : EMOJI[key];

      const row = document.createElement('div');
      row.className = 'bar-row';
      row.innerHTML = `
        <div class="bar-label">${displayLabel}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;"></div>
        </div>
        <div class="bar-pct">${pct}%</div>
      `;
      $bars.appendChild(row);

      setTimeout(() => {
        row.querySelector(".bar-fill").classList.add("show");
      }, 10);
    });
  }

  // Render cards
  const grid = document.getElementById('card-grid');
  function renderCards(list){
    if (!grid || !Array.isArray(list)) return;

    grid.style.gridTemplateColumns = (window.innerWidth >= 960) ? '1fr 1fr' : '1fr';
    grid.innerHTML = '';

    list.forEach(card => {
      const el = document.createElement('article');
      el.className = 'rec-card';
      el.style.cssText =
        'border:1px solid #eee;' +
        'border-radius:12px;' +
        'overflow:hidden;' +
        'background:#fff;' +
        'box-shadow:0 6px 20px rgba(0,0,0,.06)';

      el.innerHTML = `
        <div style="aspect-ratio:4/3;background:#f0f0f0">
          <img
            src="${card.hero || 'assets_img/placeholder.jpg'}"
            alt="${card.title}"
            style="width:100%;height:100%;object-fit:cover"
          >
        </div>
        <div style="padding:12px">
          <h3 style="margin:0 0 6px;font-size:18px">${card.title}</h3>
          <p style="margin:0 0 6px;color:#666">
            <strong>${card.mood}</strong> ¬∑ ${card.weather} ¬∑
            <span style="background:#f5f5f5;border-radius:8px;padding:2px 6px">
              ${card.palette_text || ''}
            </span>
          </p>
          <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
            <div>
              <div style="font-weight:600;margin-bottom:4px">Items</div>
              <ul style="margin:0;padding-left:18px">
                ${(card.items || []).map(i => `<li>${i}</li>`).join('')}
              </ul>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:4px">Accessories</div>
              <ul style="margin:0;padding-left:18px">
                ${(card.accessories || []).map(a => `<li>${a}</li>`).join('')}
              </ul>
            </div>
          </div>
          <p style="margin:8px 0 0;color:#444">${card.description || ''}</p>
        </div>
      `;

      grid.appendChild(el);
    });
  }

  // üå∏ Hero ‚Üí Prediction ÌôîÎ©¥ Ï†ÑÌôò
  document.getElementById("heroStart").addEventListener("click", () => {
    const hero = document.getElementById("hero");
    const mainPage = document.getElementById("mainPage");
    const pred = document.getElementById("pred-section");

    hero.classList.add("hiddenPage");

    setTimeout(() => {
      mainPage.classList.remove("hiddenPage");
      mainPage.classList.add("showPage");
      pred.classList.add("show");
      pred.scrollIntoView({ behavior: "smooth" });
    }, 300);
  });

  // Î†àÏù¥ÏïÑÏõÉ Î≥ÄÍ≤Ω Ïãú Ïπ¥Îìú Î†àÏù¥ÏïÑÏõÉ Ïû¨Ï°∞Ï†ï (ÌïÑÏöîÌïòÎ©¥ ÌôïÏû•)
  window.addEventListener('resize',()=>{
    // ÌïÑÏöîÌïòÎ©¥ Ïó¨Í∏∞ÏÑú Îã§Ïãú renderCards Ìò∏Ï∂úÌï† Ïàò ÏûàÏùå
  });
</script>
