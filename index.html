<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mood Classifier â€” Style Recommender</title>

  <!-- Google Font: Fredoka -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="style2.css">

  <!-- TensorFlow + Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>

  <!-- ğŸŒ¸ Hero Section -->
  <section id="hero">
    <div class="hero-inner">
      <h1 class="hero-title">
        Check your mood.<br>
        Match your style.<br>
        <span class="hero-accent">Start your day with confidence.</span>
      </h1>

      <img src="assets_img/hero.jpg" alt="Fashion mood cover" class="hero-img">

      <button id="heroStart" class="hero-btn">
        âœ¨ Start your style journey
      </button>
    </div>
  </section>

  <!-- ğŸŒ™ Main Page -->
  <main class="grid hiddenPage" id="mainPage">

    <section class="card">
      <h2>Overview</h2>
      <p class="muted">Input â†’ inference â†’ feedback â†’ action.</p>
    </section>

    <!-- 1) Controls -->
    <section class="card">
      <h2>1) Input & Controls</h2>

      <div class="row" style="margin-top:8px">
        <button id="btnCam" class="primary" disabled>Start Camera</button>
        <button id="btnCapture" disabled>ğŸ“· Capture in 3s</button>
        <label for="file" class="sr-only">Upload image</label>
        <input id="file" type="file" accept="image/*" />
        <button id="btnReset">Reset</button>
      </div>

      <div class="row" style="margin-top:12px">
        <video id="video" class="preview hidden" playsinline muted></video>
        <img id="img" class="preview hidden" />
        <canvas id="canvas" class="preview hidden"></canvas>
      </div>

      <div id="countdown" class="hidden"
           style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
                 font-size:72px; font-weight:700; color:#fff; text-shadow:0 0 10px #000;">
      </div>

      <div id="status" class="muted" style="margin-top:8px">Idleâ€¦</div>
      <div id="msg" class="hidden" aria-live="polite" style="margin-top:8px"></div>
    </section>

    <!-- 2) Predictions -->
    <section class="card fade-in" id="pred-section">
      <h2>2) Prediction Results</h2>
      <p class="muted">Top-K labels with probabilities.</p>

      <div id="progressBox" class="hidden" style="margin-bottom:8px">
        <label class="muted">Loading model</label>
        <progress id="progress" max="100" value="0"></progress>
      </div>

      <div id="predictions" class="log" style="min-height:140px">Waiting for resultsâ€¦</div>
      <div id="bars" class="barlist"></div>
      <div id="guidance" class="muted" style="margin-top:10px"></div>

      <div class="row" style="margin-top:10px">
        <button id="btnNextWeather" class="primary" disabled>Next: Choose Weather</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">Manual</span>
        <button data-emote="happy" id="pickHappy">ğŸ™‚ Happy</button>
        <button data-emote="neutral" id="pickNeutral">ğŸ˜ Neutral</button>
        <button data-emote="sad" id="pickSad">ğŸ˜¢ Sad</button>
        <button data-emote="angry" id="pickAngry">ğŸ˜  Angry</button>
      </div>
    </section>

    <!-- 3) Weather -->
    <section class="card hidden" id="weather-section">
      <h2>3) Choose Weather</h2>
      <p class="muted">Auto detected or choose manually.</p>

      <div id="weatherResult" class="muted" style="margin-top:8px;"></div>

      <div class="row" style="margin-top:8px">
        <button data-weather="Sunny">â˜€ï¸ Sunny</button>
        <button data-weather="Cloudy">â›… Cloudy</button>
        <button data-weather="Rainy">ğŸŒ§ï¸ Rainy</button>
      </div>
    </section>

    <!-- 4) Final -->
    <section class="card hidden" id="final-section">
      <h2>Final Recommendation</h2>
      <div id="card-grid" style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px"></div>
      <div class="row" style="margin-top:12px">
        <button id="btnRestart">Start Over</button>
      </div>
    </section>

  </main>

<script>
/* ------------------------------
  CONFIG + DOM
------------------------------ */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/4nP7aQpCm/";
const TOP_K = 3;
const LOW_CONF = 0.6;
const CAM_INFER_MS = 300;

const el = id => document.getElementById(id);
const EMOJI = {
  happy:"ğŸ™‚ Happy",
  sad:"ğŸ˜¢ Sad",
  angry:"ğŸ˜  Angry",
  neutral:"ğŸ˜ Neutral"
};

const $status = el("status");
const $msg = el("msg");
const $video = el("video");
const $img = el("img");
const $canvas = el("canvas");
const $pred = el("predictions");
const $bars = el("bars");
const $guide = el("guidance");
const $err = el("errorBox");
const $ok = el("okBox");
const $progress = el("progress");
const $progressBox = el("progressBox");
const $btnCam = el("btnCam");
const $file = el("file");
const $btnReset = el("btnReset");
const $btnNextWeather = el("btnNextWeather");
const $weatherSection = el("weather-section");
const $finalSection = el("final-section");
const $predSection = el("pred-section");
const $btnRestart = el("btnRestart");
const $btnCapture = el("btnCapture");
const $countdown = el("countdown");
const $weatherResult = el("weatherResult");

/* ------------------------------
  STATE
------------------------------ */
let model, maxPredictions;
let webcamStream = null;
let inferTimer = null;
let lastInfer = 0;
let isCountingDown = false;

let selectedEmotion = null;
let selectedStyle = null;
let selectedWeather = null;

const MOOD_TO_STYLE = {
  happy:"Active",
  neutral:"Minimal",
  sad:"Cozy",
  angry:"Street"
};

/* ------------------------------
  HELPERS
------------------------------ */
function announce(html, cls="") {
  $msg.className = cls;
  $msg.innerHTML = html;
  $msg.classList.remove("hidden");
}

function setError(t) {
  $err.textContent = t;
  $err.classList.remove("hidden");
  if ($ok) $ok.classList.add("hidden");
}

function setOk(t="System OK") {
  if ($ok) {
    $ok.textContent = t;
    $ok.classList.remove("hidden");
  }
  if ($err) $err.classList.add("hidden");
}

/* ------------------------------
  LOAD MODEL
------------------------------ */
async function loadModel() {
  try {
    $status.textContent = "Loading modelâ€¦";
    $progressBox.classList.remove("hidden");

    let p = 0;
    const timer = setInterval(()=>{
      p = Math.min(p+8, 96);
      $progress.value = p;
    }, 120);

    const modelURL = MODEL_URL + "model.json";
    const metaURL = MODEL_URL + "metadata.json";

    model = await tmImage.load(modelURL, metaURL);

    clearInterval(timer);
    $progress.value = 100;
    setTimeout(()=> $progressBox.classList.add("hidden"), 300);

    maxPredictions = model.getTotalClasses();
    $btnCam.disabled = false;
    $status.textContent = "Ready. Choose an input.";
  } catch(e) {
    console.error(e);
    setError("Failed to load model: " + e.message);
  }
}

/* ------------------------------
  FILE UPLOAD
------------------------------ */
$file.addEventListener("change", ev=>{
  const f = ev.target.files?.[0];
  if (!f) return announce("No file selected.","muted");
  if (!f.type.startsWith("image/")) return setError("Invalid image file.");

  stopCamera();
  $video.classList.add("hidden");
  $img.classList.remove("hidden");

  const url = URL.createObjectURL(f);
  $img.onload = async ()=>{
    URL.revokeObjectURL(url);
    await predictOnce($img);
  };
  $img.src = url;
});

/* ------------------------------
  CAMERA
------------------------------ */
async function startCamera(){
  try {
    stopCamera();
    webcamStream = await navigator.mediaDevices.getUserMedia({ video:true });
    $video.srcObject = webcamStream;
    $video.play();
    $video.classList.remove("hidden");
    $img.classList.add("hidden");
    $btnCapture.disabled = false;
    $btnCam.textContent = "Stop Camera";
  } catch(e){
    setError("Camera error: " + e.message);
  }
}

function stopCamera(){
  if (webcamStream) {
    webcamStream.getTracks().forEach(t=>t.stop());
    webcamStream = null;
  }
  $btnCapture.disabled = true;
  $btnCam.textContent = "Start Camera";
}

$btnCam.addEventListener("click", ()=>{
  if (webcamStream) stopCamera();
  else startCamera();
});

$btnCapture.addEventListener("click", ()=>{
  if (!webcamStream) return announce("Turn on camera first.");

  let count = 3;
  isCountingDown = true;
  $countdown.textContent = count;
  $countdown.classList.remove("hidden");

  const timer = setInterval(async()=>{
    count--;
    if (count>0) {
      $countdown.textContent = count;
    } else {
      clearInterval(timer);
      $countdown.classList.add("hidden");
      isCountingDown = false;
      await predictOnce($video);
    }
  },1000);
});

/* ------------------------------
  MANUAL EMOTION Buttons
------------------------------ */
["pickHappy","pickNeutral","pickSad","pickAngry"].forEach(id=>{
  const b = el(id);
  if (!b) return;
  b.addEventListener("click",()=>{
    const val = b.getAttribute("data-emote");
    if (val) setEmotionAndEnableNext(val);
  });
});

/* ------------------------------
  WEATHER API
------------------------------ */
async function fetchWeatherByLatLon(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code`;
  const res = await fetch(url);
  const data = await res.json();
  return data.current.weather_code;
}

function mapCodeToWeatherText(code){
  if ([0,1].includes(code)) return "Sunny";
  if ([2,3,45,48].includes(code)) return "Cloudy";
  return "Rainy";
}

/* ------------------------------
  AUTO WEATHER
------------------------------ */
async function autoSetWeather(){
  if (!navigator.geolocation) {
    $weatherResult.textContent = "Geolocation not supported.";
    return;
  }

  $weatherResult.textContent = "Detecting weather...";

  navigator.geolocation.getCurrentPosition(
    async pos=>{
      try {
        const code = await fetchWeatherByLatLon(pos.coords.latitude, pos.coords.longitude);
        const w = mapCodeToWeatherText(code);
        selectedWeather = w;
        $weatherResult.innerHTML = `Detected weather: <strong>${w}</strong>`;
      } catch(e){
        $weatherResult.textContent = "Weather detection failed.";
      }
    },
    ()=>{
      $weatherResult.textContent = "Location permission denied.";
    }
  );
}

/* ------------------------------
  GOTO WEATHER STEP
------------------------------ */
function gotoWeatherStep(){
  if (!selectedStyle) {
    announce("Please finish face detection first.","muted");
    return;
  }

  $predSection.classList.add("hidden");
  $weatherSection.classList.remove("hidden");
  $finalSection.classList.add("hidden");

  autoSetWeather();
}

$btnNextWeather.addEventListener("click", gotoWeatherStep);

/* ------------------------------
  WEATHER MANUAL BUTTONS
------------------------------ */
$weatherSection.querySelectorAll("button[data-weather]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    selectedWeather = btn.getAttribute("data-weather");
    showFinalCard();
  });
});

/* ------------------------------
  INFERENCE
------------------------------ */
async function predictOnce(source){
  if (!model) return announce("Load model first.");

  const W = 224, H = 224;
  $canvas.width = W; $canvas.height = H;
  const ctx = $canvas.getContext("2d");
  ctx.drawImage(source,0,0,W,H);

  const preds = await model.predict($canvas);
  const sorted = preds.sort((a,b)=>b.probability - a.probability).slice(0,TOP_K);

  $pred.textContent = sorted
    .map(p => `${p.className} - ${(p.probability*100).toFixed(1)}%`)
    .join("\n");

  renderBars(sorted);

  const best = sorted[0];
  if (!best) return;

  const label = best.className.toLowerCase();
  let emote = null;
  if (label.includes("happy")) emote = "happy";
  if (label.includes("neutral")) emote = "neutral";
  if (label.includes("sad")) emote = "sad";
  if (label.includes("angry")) emote = "angry";

  if (emote) setEmotionAndEnableNext(emote);
}

function setEmotionAndEnableNext(emote){
  selectedEmotion = emote;
  selectedStyle = MOOD_TO_STYLE[emote];
  $btnNextWeather.disabled = !selectedStyle;
  announce(`Emotion: ${emote} â†’ Style: ${selectedStyle}`,"muted");
}

/* ------------------------------
  RENDER BARS
------------------------------ */
function renderBars(list){
  $bars.innerHTML = "";
  if (!list) return;

  const top1 = list[0];

  list.forEach(p=>{
    const pct = Math.round(p.probability * 100);
    const key =
      p.className.toLowerCase().includes("happy") ? "happy" :
      p.className.toLowerCase().includes("sad") ? "sad" :
      p.className.toLowerCase().includes("angry") ? "angry" :
      "neutral";

    const label =
      (p === top1 ? "ğŸ”¥ " : "") + EMOJI[key];

    const row = document.createElement("div");
    row.className = "bar-row";
    row.innerHTML = `
      <div class="bar-label">${label}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%"></div>
      </div>
      <div class="bar-pct">${pct}%</div>
    `;
    $bars.appendChild(row);
  });
}

/* ------------------------------
  FINAL CARD
------------------------------ */
function showFinalCard(){
  if (!selectedStyle || !selectedWeather) {
    announce("Missing style or weather.","muted");
    return;
  }

  const target = RECOMMENDATIONS.find(
    x => x.mood === selectedStyle && x.weather === selectedWeather
  );

  renderCards(target ? [target] : []);

  $predSection.classList.add("hidden");
  $weatherSection.classList.add("hidden");
  $finalSection.classList.remove("hidden");
  $finalSection.scrollIntoView({ behavior:"smooth" });
}

/* ------------------------------
  RESTART
------------------------------ */
$btnRestart.addEventListener("click", ()=>{
  selectedEmotion = selectedStyle = selectedWeather = null;

  $predSection.classList.remove("hidden");
  $weatherSection.classList.add("hidden");
  $finalSection.classList.add("hidden");

  $pred.textContent = "Waiting for resultsâ€¦";
  $guide.textContent = "";
  $btnNextWeather.disabled = true;

  stopCamera();
  $img.classList.add("hidden");
  $video.classList.add("hidden");
});

/* ------------------------------
  RECOMMENDATION DATA
------------------------------ */
const RECOMMENDATIONS = [
  { id:"active_sunny", title:"Active Ã— Sunny", mood:"Active", weather:"Sunny",
    hero:"assets_img/active_sunny.jpg",
    palette_text:"Red / Orange / Yellow",
    items:["Cotton T-shirt","Mini skirt","Sneakers"],
    accessories:["Sunglasses","Cap","Bracelet"],
    description:"Bright energy that matches a sunny day." },

  { id:"active_cloudy", title:"Active Ã— Cloudy", mood:"Active", weather:"Cloudy",
    hero:"assets_img/active_cloudy.jpg",
    palette_text:"Orange / Yellow (soft)",
    items:["T-shirt + cardigan","Light pants"],
    accessories:["Bucket hat","Small crossbody"],
    description:"Light layers for cloudy days." },

  { id:"active_rainy", title:"Active Ã— Rainy", mood:"Active", weather:"Rainy",
    hero:"assets_img/active_rainy.jpg",
    palette_text:"Bright inner + neutral outer",
    items:["Rain jacket","Pants","Water sneakers"],
    accessories:["Bucket hat","Backpack"],
    description:"Add bright accents under waterproof layer." },

  { id:"minimal_sunny", title:"Minimal Ã— Sunny", mood:"Minimal", weather:"Sunny",
    hero:"assets_img/minimal_sunny.jpg",
    palette_text:"Beige / Light Blue / White",
    items:["Light blue shirt","White pants"],
    accessories:["Mini tote","Metal watch"],
    description:"Clean & bright minimalist look." },

  { id:"minimal_cloudy", title:"Minimal Ã— Cloudy", mood:"Minimal", weather:"Cloudy",
    hero:"assets_img/minimal_cloudy.jpg",
    palette_text:"Beige / Light Blue",
    items:["Shirt + cardigan","Chino pants"],
    accessories:["Slim belt","Sneakers"],
    description:"Soft mid-tones for cloudy weather." },

  { id:"minimal_rainy", title:"Minimal Ã— Rainy", mood:"Minimal", weather:"Rainy",
    hero:"assets_img/minimal_rainy.jpg",
    palette_text:"Beige trench",
    items:["Trench coat","Shirt","Slacks"],
    accessories:["Mini tote","Watch"],
    description:"Clean silhouette for rainy day." },

  { id:"cozy_sunny", title:"Cozy Ã— Sunny", mood:"Cozy", weather:"Sunny",
    hero:"assets_img/cozy_sunny.jpg",
    palette_text:"Navy / Gray",
    items:["Light knit","Relaxed pants"],
    accessories:["Light scarf","Canvas bag"],
    description:"Cozy and lightweight for sunny days." },

  { id:"cozy_cloudy", title:"Cozy Ã— Cloudy", mood:"Cozy", weather:"Cloudy",
    hero:"assets_img/cozy_cloudy.jpg",
    palette_text:"Warm textures",
    items:["Knit sweater","Coat"],
    accessories:["Scarf","Warm bag"],
    description:"Warm tones for comfort on cloudy days." },

  { id:"cozy_rainy", title:"Cozy Ã— Rainy", mood:"Cozy", weather:"Rainy",
    hero:"assets_img/cozy_rainy.jpg",
    palette_text:"Navy / Dark tones",
    items:["Hooded coat","Dark jeans"],
    accessories:["Chelsea boots","Umbrella"],
    description:"Warm + water-ready cozy look." },

  { id:"street_sunny", title:"Street Ã— Sunny", mood:"Street", weather:"Sunny",
    hero:"assets_img/street_sunny.jpg",
    palette_text:"Purple / Brown / Green",
    items:["Graphic tee","Cargo shorts"],
    accessories:["Cap","Chain"],
    description:"Street style with bright accents." },

  { id:"street_cloudy", title:"Street Ã— Cloudy", mood:"Street", weather:"Cloudy",
    hero:"assets_img/street_cloudy.jpg",
    palette_text:"Muted tones",
    items:["Oversized hoodie","Wide pants"],
    accessories:["Sneakers","Crossbody"],
    description:"Bold silhouette for gray weather." },

  { id:"street_rainy", title:"Street Ã— Rainy", mood:"Street", weather:"Rainy",
    hero:"assets_img/street_rainy.jpg",
    palette_text:"Tech mix",
    items:["Rain jacket","Cargo pants"],
    accessories:["Bucket hat","Grip sneakers"],
    description:"Techwear-inspired street look." }
];

/* ------------------------------
  RENDER CARDS
------------------------------ */
const grid = document.getElementById("card-grid");

function renderCards(list){
  grid.innerHTML = "";
  if (!list) return;

  list.forEach(card=>{
    const el = document.createElement("article");
    el.className = "rec-card";
    el.style.cssText =
      "border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)";

    el.innerHTML = `
      <div style="aspect-ratio:4/3;background:#f0f0f0">
        <img src="${card.hero}" style="width:100%;height:100%;object-fit:cover">
      </div>
      <div style="padding:12px">
        <h3 style="margin:0 0 6px;font-size:18px">${card.title}</h3>
        <p style="margin:0 0 6px;color:#666">
          <strong>${card.mood}</strong> Â· ${card.weather} Â·
          <span style="background:#f5f5f5;border-radius:8px;padding:2px 6px">${card.palette_text}</span>
        </p>
        <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
          <div>
            <div style="font-weight:600;margin-bottom:4px">Items</div>
            <ul style="margin:0;padding-left:18px">
              ${card.items.map(i=>`<li>${i}</li>`).join("")}
            </ul>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:4px">Accessories</div>
            <ul style="margin:0;padding-left:18px">
              ${card.accessories.map(a=>`<li>${a}</li>`).join("")}
            </ul>
          </div>
        </div>
        <p style="margin:8px 0 0;color:#444">${card.description}</p>
      </div>
    `;

    grid.appendChild(el);
  });
}

/* ------------------------------
  HERO TRANSITION
------------------------------ */
document.getElementById("heroStart").addEventListener("click", ()=>{
  const hero = document.getElementById("hero");
  const mainPage = document.getElementById("mainPage");

  hero.classList.add("hiddenPage");

  setTimeout(()=>{
    mainPage.classList.remove("hiddenPage");
    mainPage.classList.add("showPage");
    document.getElementById("pred-section").scrollIntoView({ behavior:"smooth" });
  },300);
});

/* ------------------------------
  INIT
------------------------------ */
(async ()=>{
  await loadModel();
})();
</script>

</body>
</html>
