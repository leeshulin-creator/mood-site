<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mood Classifier â€” Web Starter (TF.js + Teachable Machine)</title>
  <!-- Accessibility: readable default fonts and high-contrast base -->
  <style>
    :root{--gap:12px;--radius:16px;--shadow:0 6px 20px rgba(0,0,0,.08)}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,Pretendard,sans-serif;margin:0;background:#f7f7fb;color:#111}
    header{padding:20px 16px;text-align:center}
    h1{font-size:22px;margin:0 0 4px}
    main{max-width:920px;margin:0 auto;padding:0 16px 48px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:960px){.grid{grid-template-columns:360px 1fr}}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap}
    button,input[type=file]{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:focus, input:focus, select:focus{outline:3px solid #70a6ff44}
    .primary{background:#111;color:#fff;border-color:#111}
    .muted{color:#666}
    .hidden{display:none}
    .preview{width:100%;aspect-ratio:4/3;border-radius:12px;object-fit:cover;background:#eee}
    .log{font-family:ui-monospace,Consolas,monospace;background:#0b1020;color:#e5ecff;border-radius:12px;padding:12px;overflow:auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef;}
    progress{width:100%;height:16px}
    .error{background:#fff0f0;border:1px solid #ffd7d7;color:#820000;padding:10px 12px;border-radius:12px}
    .good{background:#f0fff4;border:1px solid #d4f5dc;color:#004a1f;padding:10px 12px;border-radius:12px}
    .kbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    kbd{background:#f0f0f0;border:1px solid #ddd;border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-family:ui-monospace,Consolas,monospace}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
  <!-- Teachable Machine Image library & TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <header>
    <h1 aria-label="ê¸°ë¶„ ë¶„ë¥˜ê¸° ì›¹ ìŠ¤íƒ€í„°">ğŸ˜ Mood Classifier â€” Web Starter</h1>
    <p class="muted">ì…ë ¥ â†’ ì¶”ë¡  â†’ í”¼ë“œë°± â†’ í–‰ë™ Â· ìƒìœ„ K ë¼ë²¨ê³¼ í™•ë¥  í‘œì‹œ Â· ë‚®ì€ í™•ì‹  ì‹œ ê°€ì´ë“œ ì œê³µ</p>
  </header>

  <main class="grid" id="app">
    <!-- Controls & Preview -->
    <section class="card" aria-labelledby="controls-title">
      <h2 id="controls-title">1) ì…ë ¥ & ì œì–´</h2>
      <p class="muted">ì¹´ë©”ë¼ ë˜ëŠ” íŒŒì¼ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. í‚¤ë³´ë“œë§Œìœ¼ë¡œë„ ì¡°ì‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

      <div class="row kbar" aria-label="Keyboard shortcuts">
        <span class="badge">ë‹¨ì¶•í‚¤</span>
        <span><kbd>C</kbd> ì¹´ë©”ë¼ ì‹œì‘/ì •ì§€</span>
        <span><kbd>U</kbd> íŒŒì¼ ì—…ë¡œë“œ</span>
        <span><kbd>R</kbd> ë‹¤ì‹œ ì‹œë„</span>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnCam" class="primary" aria-pressed="false" aria-controls="video" title="ì¹´ë©”ë¼ ì‚¬ìš©" disabled>ì¹´ë©”ë¼ ì‹œì‘</button>
        <label for="file" class="sr-only">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
        <input id="file" type="file" accept="image/*" title="ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ" />
        <button id="btnReset" title="ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
      </div>

      <div style="margin-top:12px" class="row">
        <video id="video" class="preview hidden" playsinline muted aria-label="ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°"></video>
        <img id="img" class="preview hidden" alt="ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" />
        <canvas id="canvas" class="preview hidden" aria-hidden="true"></canvas>
      </div>

      <div id="status" class="muted" style="margin-top:8px">ëŒ€ê¸° ì¤‘â€¦</div>
      <div id="msg" class="hidden" role="status" aria-live="polite" style="margin-top:8px"></div>
    </section>

    <!-- Predictions & Guidance -->
    <section class="card" aria-labelledby="pred-title" id="pred-section">
      <h2 id="pred-title">2) ì˜ˆì¸¡ ê²°ê³¼</h2>
      <p class="muted">ìƒìœ„ K ë¼ë²¨ê³¼ í™•ë¥ ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. í™•ì‹ ë„ê°€ ë‚®ìœ¼ë©´ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>

      <div id="progressBox" class="hidden" style="margin-bottom:8px">
        <label for="progress" class="muted">ëª¨ë¸ ë¡œë”©</label>
        <progress id="progress" max="100" value="0"></progress>
      </div>

      <div id="predictions" class="log" style="min-height:140px" aria-live="polite" aria-atomic="true">ê²°ê³¼ ëŒ€ê¸° ì¤‘â€¦</div>
      <div id="guidance" class="muted" style="margin-top:10px"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnNextWeather" class="primary" disabled>ë‹¤ìŒ: ë‚ ì”¨ ì„ íƒ</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">ìˆ˜ë™ ì„ íƒ</span>
        <button data-emote="happy"   id="pickHappy"   title="Happy">ğŸ™‚ Happy</button>
        <button data-emote="neutral" id="pickNeutral" title="Neutral">ğŸ˜ Neutral</button>
        <button data-emote="sad"     id="pickSad"     title="Sad">ğŸ˜¢ Sad</button>
        <button data-emote="angry"   id="pickAngry"   title="Angry">ğŸ˜  Angry</button>
      </div>
    </section>

    <!-- Notes & Errors -->
    <section class="card" aria-labelledby="notes-title">
      <h2 id="notes-title">3) ìƒíƒœ & ì—ëŸ¬</h2>
      <ul id="notes" class="muted" style="line-height:1.6">
        <li>ì˜¤ë¥˜ ìƒíƒœë¥¼ ì¸ê°„ì´ ì½ì„ ìˆ˜ ìˆëŠ” ë©”ì‹œì§€ë¡œ ì•Œë ¤ì¤ë‹ˆë‹¤.</li>
        <li>ë„¤íŠ¸ì›Œí¬ ëŠê¹€ / ê¶Œí•œ ê±°ë¶€ / ì˜ëª»ëœ íŒŒì¼ / ëª¨ë¸ ë¯¸ë¡œë”© ë“±ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.</li>
        <li>ì„œë²„ í˜¸ì¶œì€ ì—†ìœ¼ë©°, ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì¶”ë¡ í•©ë‹ˆë‹¤(ê°„ë‹¨í•œ rate-limit í¬í•¨).</li>
      </ul>
      <div id="errorBox" class="error hidden" role="alert"></div>
      <div id="okBox" class="good hidden">ì •ìƒ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤.</div>
    </section>

    <!-- Step 3: Weather selection (initially hidden) -->
    <section class="card hidden" id="weather-section" aria-labelledby="weather-title">
      <h2 id="weather-title">3) ë‚ ì”¨ ì„ íƒ</h2>
      <p class="muted">ì˜¤ëŠ˜ ë‚ ì”¨ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”. (ì´ˆê¸° ë²„ì „ì€ ìˆ˜ë™ ì„ íƒ)</p>
      <div class="row" style="margin-top:8px">
        <button data-weather="Sunny">â˜€ï¸ ë§‘ìŒ</button>
        <button data-weather="Cloudy">â›… íë¦¼</button>
        <button data-weather="Rainy">ğŸŒ§ï¸ ë¹„</button>
      </div>
    </section>

    <!-- Step 4: Final matched card (single) -->
    <section class="card hidden" aria-labelledby="final-title" id="final-section">
      <h2 id="final-title">ìµœì¢… ì¶”ì²œ</h2>
      <div id="card-grid" style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px"></div>
      <div class="row" style="margin-top:12px">
        <button id="btnRestart">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </section>
  </main>

<script>
  // === 0) ì„¤ì •ê°’ ===
  // Teachable Machine í˜¸ìŠ¤íŒ…ëœ ëª¨ë¸ URL (ë§ˆì§€ë§‰ì— '/') í¬í•¨
  const MODEL_URL = "https://teachablemachine.withgoogle.com/models/adfTD5Yf_/";
  const TOP_K = 3;           // ìƒìœ„ k ë¼ë²¨
  const LOW_CONF = 0.6;      // ë‚®ì€ í™•ì‹  ê°€ì´ë“œ ì„ê³„ê°’
  const CAM_INFER_MS = 300;  // ì¹´ë©”ë¼ ì¶”ë¡  ì£¼ê¸° (ms) â€” ê°„ë‹¨ rate-limit

  // === 1) DOM í—¬í¼ & ìš”ì†Œ ì°¸ì¡° ===
  const el = (id)=>document.getElementById(id);
  const $status = el('status');
  const $msg = el('msg');
  const $video = el('video');
  const $img = el('img');
  const $canvas = el('canvas');
  const $pred = el('predictions');
  const $guide = el('guidance');
  const $err = el('errorBox');
  const $ok = el('okBox');
  const $progress = el('progress');
  const $progressBox = el('progressBox');

  const $btnCam = el('btnCam');
  const $file = el('file');
  const $btnReset = el('btnReset');
  const $btnNextWeather = el('btnNextWeather');
  const $weatherSection = el('weather-section');
  const $finalSection = el('final-section');
  const $predSection = el('pred-section');
  const $btnRestart = el('btnRestart');

  // === ìƒíƒœ ê´€ë¦¬ (ë‹¨ê³„/ì„ íƒ) ===
  const MOOD_TO_STYLE = { happy:"Active", neutral:"Minimal", sad:"Cozy", angry:"Street" };
  let step = 1;                // 1: ì…ë ¥/ì˜ˆì¸¡ â†’ 2: ë‚ ì”¨ì„ íƒ â†’ 3: ìµœì¢…ì¹´ë“œ
  let selectedEmotion = null;  // 'happy' | 'neutral' | 'sad' | 'angry'
  let selectedStyle = null;    // 'Active' | 'Minimal' | 'Cozy' | 'Street'
  let selectedWeather = null;  // 'Sunny' | 'Cloudy' | 'Rainy'

  // === 2) ì „ì—­ ëª¨ë¸/ì¹´ë©”ë¼ ===
  let model, maxPredictions;
  let webcamStream = null;
  let inferTimer = null; // í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ, ì¶”í›„ setInterval ë°©ì‹ìœ¼ë¡œ ë°”ê¿€ ë•Œ ëŒ€ë¹„
  let lastInfer = 0;

  // ì ‘ê·¼ì„±: ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
  function announce(html, cls=""){
    $msg.className = cls || "";
    $msg.innerHTML = html;
    $msg.classList.remove('hidden');
  }
  function setError(e){
    $err.textContent = e; $err.classList.remove('hidden'); $ok.classList.add('hidden');
  }
  function setOk(t="ì •ìƒ ë™ì‘ ì¤‘ì…ë‹ˆë‹¤."){
    $ok.textContent = t; $ok.classList.remove('hidden'); $err.classList.add('hidden');
  }

  // === 3) ëª¨ë¸ ë¡œë”© ===
  async function loadModel(){
    try{
      if (typeof tmImage === 'undefined') {
        throw new Error('Teachable Machine ë¼ì´ë¸ŒëŸ¬ë¦¬(tmImage)ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” CDN ì°¨ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.');
      }
      if (!window.isSecureContext && !location.hostname.match(/^localhost|127\.0\.0\.1$/)) {
        console.warn('ë¹„ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸: ì¹´ë©”ë¼ì—ëŠ” https/localhostê°€ í•„ìš”í•©ë‹ˆë‹¤. (ëª¨ë¸ ë¡œë”©ì€ ê°€ëŠ¥)');
      }
      if(!MODEL_URL || !MODEL_URL.startsWith('http')){
        throw new Error('ëª¨ë¸ URLì„ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•˜ì„¸ìš”. (MODEL_URL)');
      }

      $status.textContent = 'ëª¨ë¸ ë¡œë”© ì¤‘â€¦';
      $progressBox.classList.remove('hidden');

      let p=0; const t = setInterval(()=>{p=Math.min(p+8, 96); $progress.value=p;}, 120);

      const modelURL = MODEL_URL + 'model.json';
      const metadataURL = MODEL_URL + 'metadata.json';
      try{
        const [headModel, headMeta] = await Promise.all([
          fetch(modelURL, { method:'GET' }),
          fetch(metadataURL, { method:'GET' })
        ]);
        if(!headModel.ok) throw new Error('model.json ì‘ë‹µì´ '+headModel.status+'ì…ë‹ˆë‹¤. URL ë˜ëŠ” ê³µê°œì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
        if(!headMeta.ok) throw new Error('metadata.json ì‘ë‹µì´ '+headMeta.status+'ì…ë‹ˆë‹¤. URL ë˜ëŠ” ê³µê°œì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
      }catch(pre){
        clearInterval(t); $progress.value=0; $progressBox.classList.add('hidden');
        throw pre;
      }

      model = await tmImage.load(modelURL, metadataURL);
      clearInterval(t); $progress.value = 100; setTimeout(()=>{$progressBox.classList.add('hidden');}, 300);

      maxPredictions = model.getTotalClasses();
      setOk('ëª¨ë¸ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ('+maxPredictions+' classes)');
      $btnCam.disabled = false; 
      $status.textContent = 'ì¤€ë¹„ ì™„ë£Œ. ì…ë ¥ì„ ì„ íƒí•˜ì„¸ìš”.';
    }catch(e){
      console.error(e); setError('ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+ e.message);
      $status.textContent = 'ì—ëŸ¬ë¡œ ì¤‘ë‹¨ë¨';
    }
  }

  // === 4) íŒŒì¼ ì—…ë¡œë“œ ===
  $file.addEventListener('change', async (ev)=>{
    try{
      const f = ev.target.files && ev.target.files[0];
      if(!f){announce('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.','muted');return}
      if(!f.type.startsWith('image/')){setError('ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');return}

      stopCamera();
      $video.classList.add('hidden');
      $img.classList.remove('hidden');
      const url = URL.createObjectURL(f);
      $img.src = url;
      $img.onload = ()=> URL.revokeObjectURL(url);

      await predictOnce($img);
    }catch(e){setError('íŒŒì¼ ì˜ˆì¸¡ ì¤‘ ì˜¤ë¥˜: '+ e.message)}
  });

  // === 5) ì¹´ë©”ë¼ ===
  async function startCamera(){
    try{
      stopCamera();
      $status.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘â€¦';
      webcamStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      $video.srcObject = webcamStream;
      $video.muted = true;
      $video.setAttribute('playsinline','');
      await $video.play();

      $img.classList.add('hidden');
      $video.classList.remove('hidden');

      if ($video.readyState >= 2) {
        startPredictLoop();
      } else {
        $video.addEventListener('loadeddata', startPredictLoop, { once:true });
      }

      $status.textContent = 'ì¹´ë©”ë¼ ì…ë ¥ ì¤‘â€¦';
      $btnCam.textContent = 'ì¹´ë©”ë¼ ì •ì§€';
      $btnCam.setAttribute('aria-pressed','true');
    }catch(e){
      console.error(e);
      setError('ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤(ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ê¸°ê¸° ë¯¸ì§€ì›).');
    }
  }

  function stopCamera(){
    if(inferTimer){clearInterval(inferTimer); inferTimer=null}
    if(webcamStream){
      webcamStream.getTracks().forEach(t=>t.stop());
      webcamStream = null;
    }
    $btnCam.textContent = 'ì¹´ë©”ë¼ ì‹œì‘';
    $btnCam.setAttribute('aria-pressed','false');
  }

  // === 5-b) rAF inference loop ===
  function startPredictLoop(){
    if(!model || !$video || !webcamStream) return;
    const loop = (ts) => {
      if(!webcamStream) return;
      if (ts - lastInfer >= CAM_INFER_MS) {
        lastInfer = ts;
        predictOnce($video).catch(console.warn);
      }
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  $btnCam.addEventListener('click',()=>{
    if(webcamStream) stopCamera(); else startCamera();
  });

  // ìˆ˜ë™ ê°ì • ì„ íƒ ë²„íŠ¼ë“¤
  ['pickHappy','pickNeutral','pickSad','pickAngry'].forEach(id=>{
    const elBtn = document.getElementById(id);
    if(!elBtn) return;
    elBtn.addEventListener('click',()=>{
      const m = elBtn.getAttribute('data-emote');
      if(m){ setEmotionAndEnableNext(m); }
    });
  });

  // ë‹¤ìŒ: ë‚ ì”¨ ì„ íƒ ë²„íŠ¼
  $btnNextWeather.addEventListener('click',()=>{
    gotoWeatherStep();
  });

  // ë‚ ì”¨ ì„ íƒ ë²„íŠ¼ë“¤
  $weatherSection.querySelectorAll('button[data-weather]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      selectedWeather = btn.getAttribute('data-weather');
      showFinalCard();
    });
  });

  // ë‹¤ì‹œ ì‹œì‘
  $btnRestart.addEventListener('click',()=>{
    selectedEmotion = null; selectedStyle = null; selectedWeather = null; step = 1;
    $predSection.classList.remove('hidden');
    $weatherSection.classList.add('hidden');
    $finalSection.classList.add('hidden');
    $pred.textContent = 'ê²°ê³¼ ëŒ€ê¸° ì¤‘â€¦';
    $guide.textContent = '';
    $btnNextWeather.disabled = true;
    stopCamera();
    $video.classList.add('hidden');
    $img.classList.add('hidden');
    setOk('ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.');
  });

  // === 6) ì´ˆê¸°í™” ===
  $btnReset.addEventListener('click',()=>{
    stopCamera();
    $video.classList.add('hidden');
    $img.src = '';
    $img.classList.add('hidden');
    $pred.textContent = 'ê²°ê³¼ ëŒ€ê¸° ì¤‘â€¦';
    $guide.textContent = '';
    setOk(); announce('ì´ˆê¸°í™” ì™„ë£Œ','muted');
  });

  // === 7) ì˜ˆì¸¡ ===
  async function predictOnce(sourceEl){
    if(!model){announce('ë¨¼ì € ëª¨ë¸ì„ ë¡œë“œí•˜ì„¸ìš”.','muted');return}
    const W=224, H=224;
    $canvas.width=W; $canvas.height=H;
    const ctx=$canvas.getContext('2d');
    ctx.drawImage(sourceEl,0,0,W,H);

    const predictions = await model.predict($canvas);
    const sorted = predictions.sort((a,b)=>b.probability - a.probability).slice(0, TOP_K);

    const lines = sorted.map(p=>{
      const pct = (p.probability*100).toFixed(1);
      return `${p.className.padEnd(12,' ')}  ${pct}%`;
    });
    $pred.textContent = lines.join('\n');

    const best = sorted[0];
    if(best && best.probability < LOW_CONF){
      $guide.innerHTML = 'í™•ì‹ ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. <strong>ë°°ê²½ ë‹¨ìˆœí™”</strong>, <strong>ì¡°ëª… ë³´ê°•</strong>, <strong>í”„ë ˆì„ ì±„ìš°ê¸°</strong> í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.';
    }else{
      $guide.textContent = '';
    }

// ì˜ˆì¸¡ëœ ë¼ë²¨ì„ ê°ì •ìœ¼ë¡œ ìë™ ë§¤í•‘ ì‹œë„ (ì˜ˆ: Happy, Neutral, Sad, Angry)
if (best) {
  const label = (best.className || '').toLowerCase();
  let emote = null;
  if(label.startsWith('happy') || label.includes('happy')) emote = 'happy';
  else if(label.startsWith('neutral') || label.includes('neutral')) emote = 'neutral';
  else if(label.startsWith('sad') || label.includes('sad')) emote = 'sad';
  else if(label.startsWith('angry') || label.includes('angry')) emote = 'angry';

  if(emote){
    setEmotionAndEnableNext(emote);
  }
}

    setOk();
  }

  // === 7-b) ê°ì •/ë‹¨ê³„ ë³´ì¡° í•¨ìˆ˜ ===
  function setEmotionAndEnableNext(emote){
    selectedEmotion = emote;
    selectedStyle = MOOD_TO_STYLE[emote] || null;
    $btnNextWeather.disabled = !selectedStyle;
    if(selectedStyle){
      announce(`ê°ì •: <strong>${emote}</strong> â†’ ìŠ¤íƒ€ì¼: <strong>${selectedStyle}</strong>`, 'muted');
    }
  }

  function gotoWeatherStep(){
    if(!selectedStyle){
      announce('ë¨¼ì € ê°ì •ì„ ì„ íƒí•˜ê±°ë‚˜ í‘œì • ì¸ì‹ì„ ì™„ë£Œí•˜ì„¸ìš”.','muted');
      return;
    }
    step = 2;
    $predSection.classList.add('hidden');
    $weatherSection.classList.remove('hidden');
    $finalSection.classList.add('hidden');
  }

  function showFinalCard(){
    if(!selectedStyle || !selectedWeather){
      announce('ìŠ¤íƒ€ì¼ ë˜ëŠ” ë‚ ì”¨ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.','muted');
      return;
    }
    const target = RECOMMENDATIONS.find(card=>
      card.mood === selectedStyle && card.weather === selectedWeather
    );
    const list = target ? [target] : [];
    renderCards(list);
    step = 3;
    $predSection.classList.add('hidden');
    $weatherSection.classList.add('hidden');
    $finalSection.classList.remove('hidden');
  }

  // === 8) ë‹¨ì¶•í‚¤ ì ‘ê·¼ì„± ===
  document.addEventListener('keydown',(e)=>{
    if(e.key==='c' || e.key==='C'){ e.preventDefault(); $btnCam.click(); }
    if(e.key==='u' || e.key==='U'){ e.preventDefault(); $file.click(); }
    if(e.key==='r' || e.key==='R'){ e.preventDefault(); $btnReset.click(); }
  });

  // === 9) ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ë°˜ì˜ ===
  function updateOnline(){
    if(navigator.onLine){ setOk('ì˜¨ë¼ì¸ â€” ëª¨ë¸ ë™ì‘ ê°€ëŠ¥'); }
    else{ setError('ì˜¤í”„ë¼ì¸ â€” ìµœì´ˆ ë¡œë”©ì—ëŠ” ì¸í„°ë„·ì´ í•„ìš”í•©ë‹ˆë‹¤.'); }
  }
  window.addEventListener('online', updateOnline);
  window.addEventListener('offline', updateOnline);

  // === 10) ì‹œì‘ ===
  (async ()=>{
    updateOnline();
    await loadModel();
  })();

  // ====== 11) ì¹´ë“œ ë°ì´í„° (í…ìŠ¤íŠ¸ ì „ìš© + ëŒ€í‘œ ì´ë¯¸ì§€ ê²½ë¡œ) ======
  const RECOMMENDATIONS = [
    // Active Ã— 3
    { id:"active_sunny",  title:"Active Ã— Sunny",  mood:"Active",  weather:"Sunny",
      hero:"assets_img/active_sunny.jpg",
      palette_text:"Red / Orange / Yellow (high energy)",
      items:["ë©´ í‹°ì…”ì¸ ","ë¯¸ë‹ˆìŠ¤ì»¤íŠ¸","ìŠ¤ë‹ˆì»¤ì¦ˆ"],
      accessories:["ì„ ê¸€ë¼ìŠ¤","ìº¡ ëª¨ì","ë¹„ì¦ˆ íŒ”ì°Œ"],
      description:"í–‡ì‚´ê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” ë°ê³  ììœ ë¡œìš´ ì—ë„ˆì§€." },

    { id:"active_cloudy", title:"Active Ã— Cloudy", mood:"Active", weather:"Cloudy",
      hero:"assets_img/active_cloudy.jpg",
      palette_text:"Red / Orange / Yellow (slightly toned)",
      items:["í‹°ì…”ì¸  + ì–‡ì€ ê°€ë””ê±´","ë¼ì´íŠ¸ íŒ¬ì¸ "],
      accessories:["ë²„í‚·í–‡","ê°€ë²¼ìš´ í¬ë¡œìŠ¤ë°±"],
      description:"êµ¬ë¦„ ë‚€ ë‚ ì—” ì–‡ì€ ë ˆì´ì–´ë¡œ í™œë™ì„± ìœ ì§€." },

    { id:"active_rainy",  title:"Active Ã— Rainy",  mood:"Active",  weather:"Rainy",
      hero:"assets_img/active_rainy.jpg",
      palette_text:"Red / Orange / Yellow (with neutral outer)",
      items:["ë¼ì´íŠ¸ ë ˆì¸ì¬í‚·","ë¡±íŒ¬ì¸ ","ë°©ìˆ˜ ìŠ¤ë‹ˆì»¤ì¦ˆ"],
      accessories:["ìš°ì‚°/ë²„í‚·í–‡","ì‹¤ìš©ì  ë°±íŒ©"],
      description:"ë°©ìˆ˜ ì•„ìš°í„°ì— ë°ì€ ì´ë„ˆë¡œ í™œê¸°ë¥¼ ì‚´ë¦¬ê¸°." },

    // Minimal Ã— 3
    { id:"minimal_sunny", title:"Minimal Ã— Sunny", mood:"Minimal", weather:"Sunny",
      hero:"assets_img/minimal_sunny.jpg",
      palette_text:"Beige / Light Blue / White (clean)",
      items:["ë¼ì´íŠ¸ ë¸”ë£¨ ì…”ì¸ ","í™”ì´íŠ¸ íŒ¬ì¸ "],
      accessories:["ë¯¸ë‹ˆ ë ˆë” í† íŠ¸","ì‹¬í”Œ ë©”íƒˆ ì‹œê³„"],
      description:"ë°ì€ í†¤ì˜¨í†¤ìœ¼ë¡œ ê¹”ë”í•˜ê³  ì •ëˆëœ ì¸ìƒ." },

    { id:"minimal_cloudy", title:"Minimal Ã— Cloudy", mood:"Minimal", weather:"Cloudy",
      hero:"assets_img/minimal_cloudy.jpg",
      palette_text:"Beige / Light Blue / White (balanced)",
      items:["ì…”ì¸  + ê°€ë””ê±´","ì¹˜ë…¸ íŒ¬ì¸ "],
      accessories:["ìŠ¬ë¦¼ ë²¨íŠ¸","ë¯¸ë‹ˆë©€ ìŠ¤ë‹ˆì»¤ì¦ˆ"],
      description:"êµ¬ë¦„ ë‚€ ë‚ ì—” ì¤‘ê°„ í†¤ ë ˆì´ì–´ë¡œ ì•ˆì •ê°." },

    { id:"minimal_rainy", title:"Minimal Ã— Rainy", mood:"Minimal", weather:"Rainy",
      hero:"assets_img/minimal_rainy.jpg",
      palette_text:"Beige / Light Blue / White (water-friendly)",
      items:["ë² ì´ì§€ íŠ¸ë Œì¹˜","ì…”ì¸ ","ìŠ¬ë™ìŠ¤"],
      accessories:["ë¯¸ë‹ˆ í† íŠ¸ë°±","ë©”íƒˆ ì‹œê³„"],
      description:"ë¹„ ì˜¤ëŠ” ë‚ ì—ë„ ì‹¤ë£¨ì—£ì€ ê°„ê²°í•˜ê²Œ." },

    // Cozy Ã— 3
    { id:"cozy_sunny",   title:"Cozy Ã— Sunny",   mood:"Cozy",   weather:"Sunny",
      hero:"assets_img/cozy_sunny.jpg",
      palette_text:"Navy / Black / Gray (lightweight cozy)",
      items:["ë¼ì´íŠ¸ ë‹ˆíŠ¸","ë¦´ë™ìŠ¤ë“œ íŒ¬ì¸ "],
      accessories:["ì†Œí”„íŠ¸ ë¨¸í”ŒëŸ¬(ê°€ë²¼ìš´ ì†Œì¬)","ìº”ë²„ìŠ¤ ë°±"],
      description:"ê°€ë²¼ìš´ ë‹ˆíŠ¸ì™€ ë¶€ë“œëŸ¬ìš´ í†¤ìœ¼ë¡œ í¸ì•ˆí•¨." },

    { id:"cozy_cloudy",  title:"Cozy Ã— Cloudy",  mood:"Cozy",   weather:"Cloudy",
      hero:"assets_img/cozy_cloudy.jpg",
      palette_text:"Navy / Black / Gray (warm)",
      items:["ë‹ˆíŠ¸","ì½”íŠ¸"],
      accessories:["ë¨¸í”ŒëŸ¬","ë”°ëœ»í•œ ì†Œì¬ì˜ ê°€ë°©"],
      description:"ì €ì±„ë„ í†¤ê³¼ í¬ê·¼í•œ ì§ˆê°ìœ¼ë¡œ ì•ˆì •ê°." },

    { id:"cozy_rainy",   title:"Cozy Ã— Rainy",   mood:"Cozy",   weather:"Rainy",
      hero:"assets_img/cozy_rainy.jpg",
      palette_text:"Navy / Black / Gray (weather-care)",
      items:["í›„ë“œ ì½”íŠ¸","ë‹¤í¬ ì§„"],
      accessories:["ë°©ìˆ˜ ë¶€ì¸ (ì²¼ì‹œ)","ìš°ì‚°"],
      description:"ë°©ìˆ˜+ë³´ì˜¨ìœ¼ë¡œ í¬ê·¼í•¨ì„ ì§€í‚¤ê¸°." },

    // Street Ã— 3
    { id:"street_sunny", title:"Street Ã— Sunny", mood:"Street", weather:"Sunny",
      hero:"assets_img/street_sunny.jpg",
      palette_text:"Purple / Brown / Green (light mix)",
      items:["ê·¸ë˜í”½ í‹°","ì¹´ê³  ì‡¼ì¸ "],
      accessories:["ìº¡","ì²´ì¸ ë¸Œë ˆì´ìŠ¬ë¦¿"],
      description:"ê°€ë²¼ìš´ ì†Œì¬ì— ìŠ¤íŠ¸ë¦¬íŠ¸ í¬ì¸íŠ¸ ì»¬ëŸ¬." },

    { id:"street_cloudy", title:"Street Ã— Cloudy", mood:"Street", weather:"Cloudy",
      hero:"assets_img/street_cloudy.jpg",
      palette_text:"Purple / Brown / Green (muted)",
      items:["ì˜¤ë²„í• í›„ë””","ì™€ì´ë“œ íŒ¬ì¸ "],
      accessories:["ë³¼ë“œ ìŠ¤ë‹ˆì»¤ì¦ˆ","í¬ë¡œìŠ¤ë°±"],
      description:"ë¬´ì±„ìƒ‰ ë‚ ì”¨ì—” ì‹¤ë£¨ì—£ìœ¼ë¡œ ì¡´ì¬ê°." },

    { id:"street_rainy", title:"Street Ã— Rainy", mood:"Street", weather:"Rainy",
      hero:"assets_img/street_rainy.jpg",
      palette_text:"Purple / Brown / Green (tech mix)",
      items:["ë ˆì¸ ì¬í‚·","ì¹´ê³  íŒ¬ì¸ "],
      accessories:["ë²„í‚·í–‡(ë°©ìˆ˜)","í•˜ì´ê·¸ë¦½ ìŠ¤ë‹ˆì»¤ì¦ˆ"],
      description:"í…Œí¬ì›¨ì–´ ìš”ì†Œë¡œ ê°•ë ¬í•¨ê³¼ ì‹¤ìš©ì„± ëª¨ë‘." }
  ];

  // ====== 12) ì¹´ë“œ ë Œë”ë§ ======
  const grid = document.getElementById('card-grid');
  function renderCards(list){
    if(!grid || !Array.isArray(list)) return;
    grid.style.gridTemplateColumns = window.innerWidth>=960 ? '1fr 1fr' : '1fr';
    grid.innerHTML='';
    list.forEach(card=>{
      const el=document.createElement('article');
      el.className='rec-card';
      el.style.cssText='border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)';
      el.innerHTML = `
        <div style="aspect-ratio:4/3;background:#f0f0f0">
          <img src="${card.hero||'assets_img/placeholder.jpg'}" alt="${card.title}" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div style="padding:12px">
          <h3 style="margin:0 0 6px;font-size:18px">${card.title}</h3>
          <p style="margin:0 0 6px;color:#666">
            <strong>${card.mood}</strong> Â· ${card.weather} Â·
            <span style="background:#f5f5f5;border-radius:8px;padding:2px 6px">${card.palette_text||''}</span>
          </p>
          <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
            <div>
              <div style="font-weight:600;margin-bottom:4px">ì•„ì´í…œ</div>
              <ul style="margin:0;padding-left:18px">${(card.items||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:4px">ì•…ì„¸ì‚¬ë¦¬</div>
              <ul style="margin:0;padding-left:18px">${(card.accessories||[]).map(a=>`<li>${a}</li>`).join('')}</ul>
            </div>
          </div>
          <p style="margin:8px 0 0;color:#444">${card.description||''}</p>
        </div>`;
      grid.appendChild(el);
    });
  }

  // (í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì—) ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë ˆì´ì•„ì›ƒë§Œ ë‹¤ì‹œ ì¡°ì •
  window.addEventListener('resize',()=>{
    // ë§ˆì§€ë§‰ ì¶”ì²œ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë³„ë„ë¡œ ì €ì¥í•´ë‘ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì„œ ì‚¬ìš©
  });
</script>
</body>
</html>
